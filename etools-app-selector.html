<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/device-icons.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-styles/element-styles/paper-material-styles.html">
<link rel="import" href="app-selector-icons.html">

<!--
`etools-app-selector`
App selector menu

@demo demo/index.html
-->

<dom-module id="etools-app-selector">
  <template>
    <custom-style>
      <style is="custom-style" include="paper-material-styles">
        :host {
          --paper-icon-button: {
            box-sizing: content-box !important;
            padding: 0;
            height: 36px;
            width: 36px;
          };
        }

        paper-icon-button.apps-button {
          @apply --layout-horizontal;
          width: 24px;
          height: 24px;
          padding: 18px 24px 18px 24px;
          color: var(--header-secondary-text-color, rgba(255, 255, 255, 0.7));
          border-right: 1px solid var(--light-divider-color, rgba(255, 255, 255, 0.12));
          z-index: 100;
          box-sizing: content-box !important;
        }

        paper-icon-button.icon-opened {
          background: #ffffff;
          color: var(--dark-primary-text-color, rgba(0, 0, 0, 0.87));
        }

        .container {
          @apply --layout-vertical;
          position: relative;
        }

        .apps-select {
          position: absolute;
          background: var(--primary-element-background, #FFFFFF);
          top: 60px;
          z-index: 100;
          padding: 0;
        }

        .content-wrapper {
          @apply --layout-horizontal;
          padding: 5px;
          box-sizing: border-box;
          font-size: 14px;
          white-space: nowrap;
          border-bottom: 1px solid rgba(0, 0, 0, 0.12);
          border-left: 1px solid rgba(0, 0, 0, 0.12);
        }

        .panel {
          width: 179px;
          height: 100%;
          align-items: center;
        }

        .panel:hover {
          background: var(--app-selector-item-hover-color, #eeeeee);
        }

        .app-title {
          font-size: 13px;
          font-weight: 500;
          padding-left: 6px;
          padding-right: 6px;
          line-height: 1.2;
          cursor: pointer;
          white-space: normal;
          display: block;
          justify-content: center;
          max-width: 116px;
        }

        .weight-500 {
          font-weight: 500;
          padding-right: 4px;
          font-size: 12px;
        }

        .etools-apps {
          width: 360px;
        }

        svg #adminIcon path.option,
        svg #externalIcon path.option {
          fill: var(--light-theme-secondary-color, #cccccc);
        }

        .admin {
          background: #eeeeee;
          display: flex;
          align-items: center;
          padding-left: 4px;
        }

        a, a:link, a:visited, a:hover, a:active {
          color: var(--app-selector-text-color, rgba(0, 0, 0, 0.87));
          text-decoration: none;
        }

        .module-group {
          border-right: 1px solid rgba(0, 0, 0, 0.12);
          display: flex;
          flex-direction: row;
          flex-wrap: wrap;
        }

        .module-group-title {
          text-transform: capitalize;
          font-weight: 450;
          padding: 6px;
          background: #eeeeee;
          font-size: 12px;
          border-right: 1px solid var(--divider-color);
          border-left: 1px solid var(--divider-color);
          display: flex;
          color: #444444;
        }

        .external {
          height: 18px;
          width: 18px;
        }

        .admin-icon {
          height: 24px;
          width: 24px;
        }

        .datamart > iron-icon,
        a.power-bi > paper-icon-button {
          --iron-icon-height: 36px;
          --iron-icon-width: 36px;
          --iron-icon-fill-color: var(--dark-theme-background-color, #cccccc);
          color: var(--dark-theme-background-color, #cccccc);
        }
      </style>
    </custom-style>
    
    <div class="container" id="etools-selector">
      <paper-icon-button on-tap="toggleMenu" class$="apps-button [[opened]]" icon="apps"></paper-icon-button>
      <iron-collapse id="selector" class="apps-select">
        <div class="paper-material" elevation="5">
          <div class="etools-apps">
            <span class="module-group-title">Programme Management</span>
            <div class="module-group">
              <a class="content-wrapper panel"
                href="https://www.unpartnerportal.org/login" target="_blank">
                <paper-icon-button class="panel-icon"
                                    icon="unppIcon:unppIcon">
                </paper-icon-button>
                <div class="app-title">UN Partner Portal</div>
                <paper-icon-button class="external"
                                   icon="external-icon:externalIcon">
                </paper-icon-button>
              </a>
              <template is="dom-if" if="[[_hasPermission('pmp', user)]]">
                <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/pmp/">
                  <paper-icon-button class="panel-icon"
                                    icon="app-selector-icons:pmpIcon">
                </paper-icon-button>
                  <div class="app-title">Partnership Management</div>
                </a>
              </template>
            </div>

            <template is="dom-if" if="[[_hasAnyGroupPermissions(user, 't2f', 'tpm', 'fam', 'psea')]]">
              <span class="module-group-title">Monitoring & Assurance</span>
              <div class="module-group">
                <template is="dom-if" if="[[_hasPermission('t2f', user)]]">
                  <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/t2f/">
                    <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:tripsIcon">
                    </paper-icon-button>
                    <div class="app-title">Trip Management</div>
                  </a>
                </template>

                <template is="dom-if" if="[[_hasPermission('tpm', user)]]">
                  <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/tpm/">
                    <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:tpmIcon">
                    </paper-icon-button>
                    <div class="app-title">Third Party Monitoring</div>
                  </a>
                </template>

                <template is="dom-if" if="[[_hasPermission('fam', user)]]">
                  <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/ap/">
                    <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:famIcon">
                    </paper-icon-button>
                    <div class="app-title">Financial Assurance</div>
                  </a>
                </template>

                <template is="dom-if" if="[[_hasPermission('psea', user)]]">
                  <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/psea/">
                    <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:pseaIcon">
                    </paper-icon-button>
                    <div class="app-title">PSEA Assurance</div>
                  </a>
                </template>
              </div>
            </template>

            <span class="module-group-title">Dashboards & Analytics</span>
            <div class="module-group">
              <template is="dom-if" if="[[_hasPermission('apd', user)]]">
                <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/apd/">
                  <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:apdIcon">
                  </paper-icon-button>
                  <div class="app-title">Action Points</div>
                </a>
              </template>

              <template is="dom-if" if="[[_hasPermission('dash', user)]]">
                <a class="content-wrapper panel" on-tap="goToPage" href$="[[baseSite]]/dash/">
                  <paper-icon-button class="panel-icon"
                                      icon="app-selector-icons:dashIcon">
                  </paper-icon-button>
                  <div class="app-title">Dashboards</div>
                </a>
              </template>

              <a class="power-bi content-wrapper panel" target="_blank"
                href="https://app.powerbi.com/groups/me/apps/2c83563f-d6fc-4ade-9c10-bbca57ed1ece/reports/5e60ab16-cce5-4c21-8620-de0c4c6415de/ReportSectionfe8562e6ef8c4eddcb52">
                <paper-icon-button class="panel-icon"
                                    icon="powerBi:powerBiIcon">
                </paper-icon-button>
                <div class="app-title">Implementation Intelligence (I<sup>2</sup>)</div>
                <paper-icon-button class="external"
                                    icon="external-icon:externalIcon">
                </paper-icon-button>
              </a>

              <a class="datamart content-wrapper panel"
                  href="https://datamart.unicef.io" target="_blank">
                <iron-icon icon="device:storage"></iron-icon>
                <div class="app-title">Datamart</div>
                <paper-icon-button class="external"
                                    icon="external-icon:externalIcon">
                </paper-icon-button>
              </a>
            </div>
          </div>

          <template is="dom-if" if="[[isAdmin]]">
            <a class="admin"
                on-tap="goToPage"
                href$="[[baseSite]]/admin/">
              <paper-icon-button id="adminIcon"
                                 class="admin-icon"
                                 icon="admin-icon:adminIcon">
              </paper-icon-button>
              <span class="app-title">ADMIN</span>
            </a>
          </template>
        </div>
      </iron-collapse>
    </div>
  </template>
  <script>
    'use strict';

    /**
     * @polymer
     * @customElement
     * @demo index.html
     */
    class EtoolsAppSelector extends Polymer.Element {
      static get is() {
        return 'etools-app-selector';
      }

      static get properties() {
        return {

          baseSite: {
            type: String,
            value: window.location.origin
          },

          /**
           * Class name toggle variable.
           * Used for styling when dropdown open/closed
           */
          opened: {
            type: String,
            value: ''
          },

          isAdmin: {
            type: Boolean,
            value: false
          },

          appPermissionsByGroup: {
            type: Object,
            value: {
              dash: ['UNICEF User'],
              pmp: ['UNICEF User'],
              t2f: ['UNICEF User'],
              tpm: ['UNICEF User', 'Third Party Monitor'],
              fam: ['UNICEF User', 'Auditor'],
              apd: ['UNICEF User'],
              psea: ['all']
            }
          },

          user: {
            type: Object,
            observer: '_renderIcons'
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        document.addEventListener('click', this._onCaptureClick.bind(this), true);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        document.removeEventListener('click', this._onCaptureClick.bind(this), true);
      }

      /**
       * Toggles the menu opened and closed
       *
       */
      toggleMenu() {
        this.$.selector.toggle();
        if (this.opened) {
          this.opened = '';
        } else {
          this.opened = 'icon-opened';
        }
      }

      /**
       * Navigate window to path if ctrl/command are not pressed
       */
      manageClickEvent(e, path) {
        if (!e.detail.sourceEvent.ctrlKey && !e.detail.sourceEvent.metaKey) {
          window.location.href = path;
        }
      }

      /**
       * Change location to target app url found in menuOptions array items.
       * Url prop of item should just be app name
       *
       * Example:
       *
       *  `app.url="admin" will change location to 'http://myBaseUrlAndPort/admin/' `
       *
       */
      goToPage(e) {
        var path = window.location.origin + '/' + e.model.app.url + '/';
        this.manageClickEvent(e, path);
      }

      goToAdmin(e) {
        var path = window.location.origin + '/admin/';
        this.manageClickEvent(e, path)
      }

      /**
       * Determine if click is outside of menu, close if true
       *
       */
      _onCaptureClick(e) {
        if (!this._isInPath(e.composedPath(), 'id', 'etools-selector')) {
          if (this.$.selector.opened) {
            this.toggleMenu();
          }
        }
      }

      _isInPath(path, prop, value) {
        path = path || [];
        for (var i = 0; i < path.length; i++) {
          if (path[i][prop] === value) {
            return true;
          }
        }
        return false;
      }

      _renderIcons() {
        if (!this.user) { return false; }
        this.set('isAdmin', this.isAdminUser(this.user))
      }

      isAdminUser(user) {
        return user.is_superuser === 'True' || this.user.groups.find(group => group.name === 'Country Office Administrator');
      }

      _hasPermission(appName, user) {
        // checks if user object is populated
        if (!this.user || (Object.entries(user).length === 0 && user.constructor === Object)) {return false;}
        // removes PSEA if user is a TPM
        if (appName === 'psea' && user.groups.some(group => group.name === 'Third Party Monitor')) {return false;}
        let allowedGroups = this.appPermissionsByGroup[appName];
        if (allowedGroups.indexOf('all') > -1) { return true;}
        return user.groups.some(group => allowedGroups.indexOf(group.name) > -1);
      }

      _hasAnyGroupPermissions(user, ...moduleArray) {
        return moduleArray.find(mod => this._hasPermission(mod, user));
      }
    }

    customElements.define(EtoolsAppSelector.is, EtoolsAppSelector);
  </script>
</dom-module>
